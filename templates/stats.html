{% extends "base.html" %}

{% block title %}Repository Statistics - GitHub Issues Dashboard{% endblock %}

{% block content %}
<!-- Main Stats Content -->
<div class="intro-page" id="stats-page">
    <div class="intro-content">
        <div class="intro-header">
            <i class="fas fa-chart-bar intro-icon"></i>
            <h1>Repository Statistics</h1>
            <p class="intro-subtitle">Comprehensive overview of all repositories</p>
        </div>
        
        <div class="intro-stats">
            <h3>Repository Overview</h3>
            <div class="stats-grid">
                <div class="stat-item">
                    <span class="stat-number">{{ sync_stats.repositories_count }}</span>
                    <span class="stat-label">Total Repositories</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number">{{ sync_stats.total_issues }}</span>
                    <span class="stat-label">Total Issues</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number">{{ total_prs }}</span>
                    <span class="stat-label">Total Pull Requests</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number">{{ recent_issues }}</span>
                    <span class="stat-label">Recent Issues (14 days)</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number">{{ stale_issues }}</span>
                    <span class="stat-label">Stale Issues (60+ days)</span>
                </div>
            </div>
        </div>

        <div class="sync-section">
            <h3><i class="fas fa-sync-alt"></i> Synchronization Status</h3>
            <div class="sync-status-card">
                <div class="sync-status-header">
                    {% if sync_stats.sync_in_progress %}
                        <div class="status-indicator in-progress"></div>
                        <span class="sync-status-text" style="color: #ed8936;">Sync in Progress...</span>
                    {% elif sync_stats.errors > 0 %}
                        <div class="status-indicator error"></div>
                        <span class="sync-status-text" style="color: #f56565;">Ready ({{ sync_stats.errors }} errors)</span>
                    {% else %}
                        <div class="status-indicator"></div>
                        <span class="sync-status-text" style="color: #48bb78;">Ready</span>
                    {% endif %}
                    <small class="sync-last-updated">Last updated: {{ sync_stats.last_sync_formatted }}</small>
                </div>

                <div class="sync-stats-summary">
                    <div class="sync-stat">
                        <span class="sync-stat-number">{{ sync_stats.total_open_issues }}</span>
                        <span class="sync-stat-label">Open Issues</span>
                    </div>
                    <div class="sync-stat">
                        <span class="sync-stat-number">{{ sync_stats.total_closed_issues }}</span>
                        <span class="sync-stat-label">Closed Issues</span>
                    </div>
                    <div class="sync-stat">
                        <span class="sync-stat-number">{{ sync_stats.new_issues_24h }}</span>
                        <span class="sync-stat-label">New (24h)</span>
                    </div>
                    <div class="sync-stat">
                        <span class="sync-stat-number">{{ sync_stats.updated_issues_24h }}</span>
                        <span class="sync-stat-label">Updated (24h)</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="repo-breakdown">
            <h3><i class="fas fa-list"></i> Repository Breakdown</h3>
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="thead-dark">
                        <tr>
                            <th>Repository</th>
                            <th>Open</th>
                            <th>Closed</th>
                            <th>New (24h)</th>
                            <th>Updated (24h)</th>
                            <th>Last Updated</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for repo_name, repo_stat in sync_stats.repo_stats.items() %}
                        <tr>
                            <td><strong>{{ repo_stat.repo }}</strong></td>
                            <td><span class="badge badge-success">{{ repo_stat.open_count }}</span></td>
                            <td><span class="badge badge-secondary">{{ repo_stat.closed_count }}</span></td>
                            <td><span class="badge badge-info">{{ repo_stat.new_24h }}</span></td>
                            <td><span class="badge badge-warning">{{ repo_stat.updated_24h }}</span></td>
                            <td><small class="text-muted">{{ repo_stat.last_updated }}</small></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        {% if sync_stats.error_details %}
        <div class="error-details">
            <h3><i class="fas fa-exclamation-triangle"></i> Error Details</h3>
            <div class="alert alert-danger">
                <pre>{{ sync_stats.error_details }}</pre>
            </div>
        </div>
        {% endif %}

        <div class="intro-actions">
            <a href="{{ url_for('dashboard') }}" class="btn btn-primary btn-lg">
                <i class="fas fa-arrow-left"></i> Back to Dashboard
            </a>
            <a href="{{ url_for('sync_page') }}" class="btn btn-secondary btn-lg">
                <i class="fas fa-sync-alt"></i> Sync Management
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Stats page loaded');
    
    // Update navbar counts for stats page
    {% if nodejs_count is defined %}
    if (document.getElementById('navbar-nodejs-count')) {
        document.getElementById('navbar-nodejs-count').textContent = '{{ nodejs_count }}';
    }
    {% endif %}
    {% if python_count is defined %}
    if (document.getElementById('navbar-python-count')) {
        document.getElementById('navbar-python-count').textContent = '{{ python_count }}';
    }
    {% endif %}
    {% if browser_count is defined %}
    if (document.getElementById('navbar-browser-count')) {
        document.getElementById('navbar-browser-count').textContent = '{{ browser_count }}';
    }
    {% endif %}
    {% if dotnet_count is defined %}
    if (document.getElementById('navbar-dotnet-count')) {
        document.getElementById('navbar-dotnet-count').textContent = '{{ dotnet_count }}';
    }
    {% endif %}
    {% if java_count is defined %}
    if (document.getElementById('navbar-java-count')) {
        document.getElementById('navbar-java-count').textContent = '{{ java_count }}';
    }
    {% endif %}
    
    // Ensure jQuery and Bootstrap are loaded
    if (typeof $ !== 'undefined' && typeof $().dropdown === 'function') {
        console.log('Bootstrap dropdowns available');
        
        // Initialize Bootstrap dropdowns explicitly
        $('.dropdown-toggle').dropdown();
        
        // Add debugging for dropdown clicks
        $('.dropdown-toggle').off('click.debug').on('click.debug', function(e) {
            console.log('Dropdown clicked:', $(this).attr('id'));
            console.log('Is dropdown initialized:', $(this).hasClass('dropdown-toggle'));
            
            // Force Bootstrap dropdown toggle
            $(this).dropdown('toggle');
        });
        
        // Check if dropdowns are working
        $('.dropdown').on('show.bs.dropdown', function() {
            console.log('Dropdown showing:', $(this).find('.dropdown-toggle').attr('id'));
        });
        
        $('.dropdown').on('hide.bs.dropdown', function() {
            console.log('Dropdown hiding:', $(this).find('.dropdown-toggle').attr('id'));
        });
    } else {
        console.error('Bootstrap dropdown functionality not available');
        console.log('jQuery available:', typeof $ !== 'undefined');
        console.log('Bootstrap dropdown method available:', typeof $().dropdown);
    }
    
    // Override dashboard.js functions that don't apply to stats page
    if (typeof window.updateSyncStatus === 'function') {
        const originalUpdateSyncStatus = window.updateSyncStatus;
        window.updateSyncStatus = function() {
            // Stats page doesn't have sync status indicators, use data from template instead
            console.log('updateSyncStatus called on stats page - using template data');
            // The actual sync status is already displayed in the template, no need for dynamic updates
        };
    }
    
    if (typeof window.fetchSyncStatus === 'function') {
        const originalFetchSyncStatus = window.fetchSyncStatus;
        window.fetchSyncStatus = function() {
            // Stats page doesn't need to fetch sync status dynamically
            console.log('fetchSyncStatus called on stats page - ignoring');
        };
    }
    
    console.log('Stats page JavaScript initialization complete');
});
</script>
{% endblock %}
